<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Run Dino</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=NO">
</head>
<body>

    <canvas id="canvas"></canvas>

    <script>

        // prevent zooming
        var resolution = window.devicePixelRatio;
        var w = window.innerWidth;
        var h = window.innerHeight;
        var w2 = Math.round(w * resolution);
        var h2 = Math.round(h * resolution);
        canvas.style.width = w + "px";
        canvas.style.height = h + "px";
        // canvas.sdf(w2, h2);

        function sound(src) {
            this.sound = document.createElement("audio");
            this.sound.src = src;
            this.sound.setAttribute("preload", "auto");
            this.sound.setAttribute("controls", "none");
            this.sound.style.display = "none";
            document.body.appendChild(this.sound);
            this.play = function(){
                this.sound.play();
            }
            this.stop = function(){
                this.sound.pause();
            }    
        }

        // score
        var score = 0;
        var gameStarted = false;
        var gameEnded = false;

        // key listeners
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);
        document.addEventListener("mousemove", mouseMoveHandler, false);

        // colors
        var colors = ['#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6', 
		  '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
		  '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A', 
		  '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
		  '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC', 
		  '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
		  '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680', 
		  '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
		  '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3', 
		  '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF'];

        // you died messages
        var deathMessages = ["You died.", "Oops", "Did someone die?", "lol", "DOOM", "Oof", "lmao", "Pathetic.", "That was fast.", "Really?", "What a cute try.",
         "RIP", "What a shame.", "Do better next time.", "Try not dying next time.", "That's all you've got?", "There's not an easy mode.", "Is this your first video game?"];
         var deathMessage;

        // sound
        var clearSound = new sound("bloop.mp3");
        var deathSound = new sound("death.mp3");
        var explosionSound = new sound("explosion.mp3");
        
        var movingDown = false;
        var movingUp = false;

        var showingText = "";

        function keyDownHandler(e) {
            if(e.key == "Up" || e.key == "ArrowUp") {
                movingUp = true;
            }
            else if(e.key == "Down" || e.key == "ArrowDown") {
                movingDown = true;
            }
            else if(e.keyCode == 32)
            {
                if(!gameStarted)
                {
                    gameStarted = true;
                    document.body.style.cursor = "none";
                    initializeDino();
                }
                if(gameEnded)
                {
                    initializeObstacles();
                    initializeDino();
                    score = 0;
                    gameEnded = false;
                }

                deathMessage = deathMessages[random(deathMessages.length)];
                
            }
        }

        function keyUpHandler(e) {
            if(e.key == "Up" || e.key == "ArrowUp") {
                movingUp = false;
            }
            else if(e.key == "Down" || e.key == "ArrowDown") {
                movingDown = false;
            }
            else if(e.keyCode == 32) { //space bar
                // console.log("Space");
            }
        }

        function mouseMoveHandler(e) {
            var relativeY = e.clientY;
            if(relativeY > 0 && relativeY < canvas.height) {
                dino.y = relativeY - dino.height/2;
            }
        }

        function random(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        //initialize dino
        var dino = {};
        function initializeDino() {
            dino.height = canvas.height/12;
            dino.width = dino.height;
            dino.x = 10;
            dino.y = canvas.height-dino.height;
            dino.birth = Date.now();
        }

        // initialize obstacles
        obstacles = [];

        function initializeObstacle(o) {
            var fractionsOfCanvas = [15,25,30,35];
            o.diameter = canvas.height/fractionsOfCanvas[random(fractionsOfCanvas.length)];
            o.x = canvas.width - o.diameter - 5;
            o.y = canvas.height - random(canvas.height);

            o.dx = 0 - (random(6) + 3) - Math.floor(score/50);

            o.dy = random(10) > 7 ? (random(2) == 1 ? random(4) : 0 - random(4)) : 0;
            
            if(random(200) == 14)
            {
                o.status = "slow";
            }
            else if(random(200) == 10)
            {
                o.status = "bomb";
            }
            else
            {
                o.color = colors[random(colors.length)];
                o.status = "kill";
            }

            return o;
        }

        function initializeObstacles() {
            for(var i=0; i < random(15) + 10; i++)
            {
                setInterval(function() {
                    if(obstacles.length < 25)
                    {
                        obstacles.push(initializeObstacle({}));
                    }
                    
                }, 300);
            }
        }

        // resize to fit
        (function() 
        {
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');

            // resize the canvas to fill browser window dynamically
            window.addEventListener('resize', resizeCanvas, false);
            
            function resizeCanvas() {
                    console.log("Resizing");
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
            }

            function showText(text) {
                ctx.font = "50px Courier New";
                ctx.fillStyle = "#424242";
                ctx.textAlign = "center";
                ctx.fillText(text, canvas.width/2, canvas.height/2);
            }

            function showSubText(text) {
                ctx.font = "20px Courier New";
                ctx.fillStyle = "#424242";
                ctx.textAlign = "center";
                ctx.fillText(text, canvas.width/2, canvas.height/2 + 50);
            }

            resizeCanvas();
            initializeObstacles();

            function drawScore() {
                ctx.font = "22px Courier New";
                ctx.fillStyle = "#0095DD";
                ctx.fillText(score, 50, 30);
            }

            function drawTitle() {
                showText("Run Dino");

                ctx.font = "20px Courier New";

                if(Math.floor(Date.now()/1000) % 4 < 2)
                {
                    showSubText("Press Space to Play");
                }
                else
                {
                    showSubText("Avoid Circles")
                }
                
            }

            function drawEndingTitle() {
                showText(deathMessage);

                ctx.font = "20px Courier New";
                ctx.fillText("Your score: " + score, canvas.width/2, (canvas.height/2) + 50);

                if(Math.floor(Date.now()/1000) % 2 == 0)
                {
                    ctx.fillText("Press Space to Continue", canvas.width/2, (canvas.height/2) + 100);
                }
            }

            function drawObstacle(o) {
                ctx.beginPath();
                ctx.fillStyle = o.color;

                if(o.status == "kill")
                {
                    ctx.arc(o.x, o.y, o.diameter/2, 0, Math.PI*2);
                    // ctx.fillRect(o.x, o.y, o.diameter, o.diameter);
                    
                }
                else if(o.status == "slow")
                {
                    ctx.font = 1.3*o.diameter + "px Courier New";
                    ctx.fillStyle = "#424242";
                    ctx.textAlign = "center";
                    ctx.fillText("🐌", o.x, o.y);
                }
                else if(o.status == "bomb")
                {
                    ctx.font = 1.3*o.diameter + "px Courier New";
                    ctx.fillStyle = "#424242";
                    ctx.textAlign = "center";
                    ctx.fillText("💣", o.x, o.y);
                }

                ctx.fill();
                ctx.closePath();
            }

            function drawDino() {
                ctx.beginPath();
                
                if(Date.now() - dino.birth > 3000)
                {
                    ctx.fillStyle = "#0095DD";
                    ctx.fillRect(dino.x, dino.y, dino.width, dino.height);
                }
                else
                {
                    showSubText("You're Indestructible!");
                    ctx.strokeRect(dino.x, dino.y, dino.width, dino.height);
                }

                ctx.fill();
                ctx.closePath();
            }
            
            function draw() {

                // anything above this line will be cleared...
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if(showingText)
                {
                    console.log("Showing " + showingText);
                    showText(showingText);
                }

                if(gameStarted)
                {
                    if(gameEnded)
                    {
                        drawEndingTitle();
                    }
                    else
                    {
                        drawDino();
                        drawScore();
                    }
                }
                else
                {
                    drawTitle();
                }

                // draw each obstacle
                for(i in obstacles)
                {
                    drawObstacle(obstacles[i]);
                }

                for(i in obstacles)
                {
                    // detect walls:
                    if(obstacles[i].x < 0) {  // obstacle cleared
                        obstacles.splice(i, 1);

                        if(gameStarted && !gameEnded)
                        {
                            score++;
                            clearSound.play();
                        }

                        continue;
                    }

                    if (dino.x < obstacles[i].x + obstacles[i].diameter
                    && dino.y < obstacles[i].y + obstacles[i].diameter/2
                    && dino.x + dino.width > obstacles[i].x
                    && dino.y + dino.height > obstacles[i].y - obstacles[i].diameter/2
                    && !gameEnded
                    && (Date.now() - dino.birth) > 3000) {  // collision

                        //testing
                        // obstacles = [obstacles[i]];
                        // ctx.clearRect(0, 0, canvas.width, canvas.height);
                        // drawDino();
                        // drawObstacle(obstacles[0]);
                        // alert("Dino X: " + dino.x + "\nDino Y: " + dino.y + "\nDino Height: " + dino.height + "\nObstacle X: " + obstacles[0].x + "\nObstacle Y: " + obstacles[0].y + "\nObstacle Diameter: " + obstacles[0].diameter);

                        if(obstacles[i].status == "kill")
                        {
                            obstacles = [];
                            deathSound.play();
                            gameEnded = true;
                            break;
                        }
                        else if(obstacles[i].status == "slow")
                        {
                            showingText = "We're going slow";

                            setTimeout(function() {
                                showingText = "";
                            }, 2000);

                            for(k in obstacles)
                            {
                                obstacles[k].dx = obstacles[k].dx / 3;
                            }

                            obstacles.splice(i,1);                        
                        }
                        else if(obstacles[i].status == "bomb")
                        {
                            explosionSound.play();
                            showingText = "A fresh start";
                            score += obstacles.length;

                            setTimeout(function() {
                                showingText = "";
                            }, 2000);

                            obstacles = [];
                            initializeObstacles();
                            break;
                 
                        }

                    }
                    else
                    {
                        obstacles[i].x += random(10) > 8 ? obstacles[i].dx-1 : obstacles[i].dx;
                        obstacles[i].y += obstacles[i].dy;

                        if(random(10000) == 2)
                        {
                            obstacles[i].dy = random(3)

                            if(random(2) == 1)
                            {
                                obstacles[i].dy = 0 -obstacles[i].dy;
                            }
                        }
                    }
                }

                // detect dino movement
                if(movingDown) {
                    dino.y += 7;
                    if (dino.y > canvas.height - dino.height){
                        dino.y = canvas.height - dino.height;
                    }
                }
                else if(movingUp) {
                    dino.y -= 7;
                    if (dino.y < 0){
                        dino.y = 0;
                    }
                }

                requestAnimationFrame(draw);
            }

            if(!gameStarted)
            {
                drawTitle();
            }

            draw();

        })();

    </script>

</body>
</html>